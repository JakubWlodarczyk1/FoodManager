@using FoodManager.Application.Extensions
@using FoodManager.Application.Common
@using FoodManager.Application.Resources.Localizations
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using FoodManager.Application.Product.Dtos
@using FoodManager.Infrastructure.Localization
@model PagedResult<ProductDto>

@{
    ViewData["Title"] = @Lang.Products;
    var pageNumber = int.TryParse(ViewContext.HttpContext.Request.Query["PageNumber"], out var pn) ? pn : PaginationDefaults.DefaultPageNumber;
    var pageSize = int.TryParse(ViewContext.HttpContext.Request.Query["PageSize"], out var ps) ? ps : PaginationDefaults.DefaultPageSize;
    var searchPhrase = ViewContext.HttpContext.Request.Query["SearchPhrase"];

    var sortBy = ViewContext.HttpContext.Request.Query["SortBy"];
    var sortDirection = ViewContext.HttpContext.Request.Query["SortDirection"] == "Descending" ? "Ascending" : "Descending";

    var startPage = Math.Max(1, pageNumber - 1);
    var endPage = Math.Min(Model.TotalPages, pageNumber + 1);

}

<h1>@Lang.Products</h1>

<p>
    <a class="btn btn-primary" asp-action="Create">@Lang.AddProduct</a>
</p>

<form method="get" asp-action="Index" class="mb-3">
    <div class="input-group">
        <input class="form-control" type="text" name="SearchPhrase" placeholder="@Lang.Search..." value="@searchPhrase" />
        <input type="hidden" name="PageSize" value="@pageSize" />
        <input type="hidden" name="PageNumber" value="@pageNumber" />
        <button type="submit" class="btn btn-primary">@Lang.Search</button>
    </div>
</form>

<p>
    @string.Format(Lang.ShowingProducts, @Model.ItemsFrom, @Model.ItemsTo, @Model.TotalItemsCount)
</p>

<table class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>
                <a class="text-dark p-0 text-decoration-none" href="@Url.Action("Index", new { pageNumber = pageNumber, pageSize = pageSize, searchPhrase = searchPhrase, sortBy = nameof(ProductDto.Name), sortDirection = sortDirection })">
                    @Lang.Name
                    @if (sortBy == nameof(ProductDto.Name))
                    {
                        <span class="sort-indicator">@((sortDirection == "Descending") ? "▲" : "▼")</span>
                    }
                    else
                    {
                        <span class="sort-indicator text-muted">⇅</span>
                    }
                </a>
            </th>
            <th>
                <a class="text-dark p-0 text-decoration-none" href="@Url.Action("Index", new { pageNumber = pageNumber, pageSize = pageSize, searchPhrase = searchPhrase, sortBy = nameof(ProductDto.Description), sortDirection = sortDirection })">
                    @Lang.Description
                    @if (sortBy == nameof(ProductDto.Description))
                    {
                        <span class="sort-indicator">@((sortDirection == "Descending") ? "▲" : "▼")</span>
                    }
                    else
                    {
                        <span class="sort-indicator text-muted">⇅</span>
                    }
                </a>
            </th>
            <th>
                @Lang.Category
            </th>
            <th>
                <a class="text-dark p-0 text-decoration-none" href="@Url.Action("Index", new { pageNumber = pageNumber, pageSize = pageSize, searchPhrase = searchPhrase, sortBy = nameof(ProductDto.Quantity), sortDirection = sortDirection })">
                    @Lang.Quantity
                    @if (sortBy == nameof(ProductDto.Quantity))
                    {
                        <span class="sort-indicator">@((sortDirection == "Descending") ? "▲" : "▼")</span>
                    }
                    else
                    {
                        <span class="sort-indicator text-muted">⇅</span>
                    }
                </a>
            </th>
            <th>
                <a class="text-dark p-0 text-decoration-none" href="@Url.Action("Index", new { pageNumber = pageNumber, pageSize = pageSize, searchPhrase = searchPhrase, sortBy = nameof(ProductDto.Price), sortDirection = sortDirection })">
                    @Lang.Price (PLN)
                    @if (sortBy == nameof(ProductDto.Price))
                    {
                        <span class="sort-indicator">@((sortDirection == "Descending") ? "▲" : "▼")</span>
                    }
                    else
                    {
                        <span class="sort-indicator text-muted">⇅</span>
                    }
                </a>
            </th>
            <th>
                <a class="text-dark p-0 text-decoration-none" href="@Url.Action("Index", new { pageNumber = pageNumber, pageSize = pageSize, searchPhrase = searchPhrase, sortBy = nameof(ProductDto.ExpirationDate), sortDirection = sortDirection })">
                    @Lang.ExpirationDate
                    @if (sortBy == nameof(ProductDto.ExpirationDate))
                    {
                        <span class="sort-indicator">@((sortDirection == "Descending") ? "▲" : "▼")</span>
                    }
                    else
                    {
                        <span class="sort-indicator text-muted">⇅</span>
                    }
                </a>
            </th>
        <th>@Lang.Actions</th>
        </tr>
    </thead>
    <tbody>
    @foreach (var item in Model.Items) {
        <tr>
            <td>@Html.DisplayFor(modelItem => item.Name)</td>
            <td>@Html.DisplayFor(modelItem => item.Description)</td>
            <td>@(TranslationHelper.GetTranslatedValue(item.CategoryTranslationKey) ?? item.CategoryName)</td>
            <td>@Html.DisplayFor(modelItem => item.Quantity) @item.Unit.GetDisplayName()</td>
            <td>@Html.DisplayFor(modelItem => item.Price)</td>
            <td>@item.ExpirationDate.ToString("dd-MM-yyyy")</td>
            <td>
                <a class="btn btn-primary" asp-action="Edit" asp-route-id="@item.Id">@Lang.Edit</a>
                <a class="btn btn-danger" asp-action="Delete" asp-route-id="@item.Id" onclick="return confirm('@Lang.DeleteProductConfirmationMessage')">@Lang.Delete</a>
            </td>
        </tr>
    }
    </tbody>
</table>

<div class="d-flex justify-content-between align-items-center mb-3">
    <!-- Pagination Controls on the Left -->
    <nav aria-label="Pagination">
        <ul class="pagination pagination-sm mb-0">
            <!-- Previous Button -->
            <li class="page-item @(pageNumber <= 1 ? "disabled" : "")">
                <a class="page-link" href="@Url.Action("Index", new { pageNumber = pageNumber - 1, pageSize = pageSize, searchPhrase = searchPhrase })">Previous</a>
            </li>

            <!-- First Page -->
            @if (startPage > 1)
            {
                <li class="page-item">
                    <a class="page-link" href="@Url.Action("Index", new { pageNumber = 1, pageSize = pageSize, searchPhrase = searchPhrase })">1</a>
                </li>
                @if (startPage > 2)
                {
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                }
            }

            <!-- Main Page Links (Up to 3 Pages) -->
            @for (int i = startPage; i <= endPage; i++)
            {
                <li class="page-item @(pageNumber == i ? "active" : "")">
                    <a class="page-link" href="@Url.Action("Index", new { pageNumber = i, pageSize = pageSize, searchPhrase = searchPhrase })">@i</a>
                </li>
            }

            <!-- Last Page -->
            @if (endPage < Model.TotalPages)
            {
                @if (endPage < Model.TotalPages - 1)
                {
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                }
                <li class="page-item">
                    <a class="page-link" href="@Url.Action("Index", new { pageNumber = Model.TotalPages, pageSize = pageSize, searchPhrase = searchPhrase })">@Model.TotalPages</a>
                </li>
            }

            <!-- Next Button -->
            <li class="page-item @(pageNumber >= Model.TotalPages ? "disabled" : "")">
                <a class="page-link" href="@Url.Action("Index", new { pageNumber = pageNumber + 1, pageSize = pageSize, searchPhrase = searchPhrase })">Next</a>
            </li>
        </ul>
    </nav>

    <!-- Page Size Selection on the Right -->
    <nav aria-label="Page size">
        <ul class="pagination pagination-sm mb-0">
            @foreach (var size in @PaginationDefaults.AllowedPageSizes)
            {
                <li class="page-item @(pageSize == size ? "active" : "")">
                    <a class="page-link" href="@Url.Action("Index", new { pageNumber = 1, pageSize = size, searchPhrase = searchPhrase })">@size</a>
                </li>
            }
        </ul>
    </nav>
</div>
